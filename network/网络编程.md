# TCP/IP网络编程

## 套接字Socket

套接字是一种通信机制，凭借这种机制，客户/服务器系统的开发工作既可以在本地单机上进行，也可以跨网络进行，Linux所提供的功能（如打印服务，ftp等）通常都是通过套接字来进行通信的。



## 套接字编程

网络编程创建连接请求的套接字过程：

1. 调用socket函数创建套接字

   > #include <sys/socket.h>
   >
   > int socket(int domain, int type, int protocol);
   >
   > domain-协议族               一般为PF_INET，代表IPv4互联网协议族
   >
   >  type-数据传输方式        SOCK_STREAM代表面向连接的套接字，对应TCP   
   >
   > ​					 SOCK_DGRAM代表面向消息的套接字，对应UDP
   >
   >  protocol-通信协议		一般设为0，表示选择当前family和type组合下的protocol
   >
   >  
   >
   > 成功返回文件描述符，失败时返回1



2. 调用bind函数分配IP地址和端口号

   > int bind(int sockfd,  sockaddr* myaddr, socklen_t addrlen);
   >
   > sockfd-套接字文件描述符
   >
   > myaddr-指向特定协议的地址结构的指针
   >
   > addrlen-该地址结构的长度
   >
   > 
   >
   > 成功返回0，失败返回-1



3. 调用listen函数转为可接收请求状态

   > int listen(int sockfd, int backlog);
   >
   > sockfd-套接字文件描述符
   >
   > backlog-连接请求等待队列的长度
   >
   >  
   >
   > 成功时返回0，失败时返回-1

 

4. 调用accept函数受理连接请求

   >  int accept(int sockfd,  sockaddr* addr,  socklent_t* addrlen);
   >
   > sockfd-套接字文件描述符
   >
   > addr-指向客户端地址结构体的指针
   >
   > addrlen-addr结构体的长度
   >
   >  
   >
   > 成功返回**创建的套接字文件描述符**，失败时返回-1

   

   

客户端创建套接字后调用connect函数

> int connect(int fd, sockaddr* serv_addr, socklen_t addrlen)





## 参数说明

- SOCK_STREAM：面向连接的套接字(TCP)

  - 传输过程数据不会丢失
  - 按序传输数据
  - 传输的数据**不存在数据边界**

  　收发的套接字内部有缓存，简言之就是字节数组。通过套接字传输的数据将保存到该数组，收到数据不意味着马上调用read函数。只要不超过数组容量，有可能在数据填充后一次read调用全部，也可能分多次进行调用，即传输的数据不存在数据边界

  　　

- sockaddr_in结构体成员变量

  - sin_family    地址族
  - sin_port        TCP/UDP端口号
  - sin_addr        IP地址
  - sin_zero         不使用

  　实际bind函数第二个参数期望得到的是sockaddr结构体变量地址值，但对于包含地址信息来讲非常麻烦，所以有了sockaddr_in结构体，生成符合bind函数要求的字节流，最后转换成sockaddr型的结构体传递给bind函数

  　　

- 字节序：CPU向内存保存数据的方式有２种，意味着CPU解析数据的方式也分为２种

  - 大端序(Big Endian)：高位字节存放到低位地址
  - 小端序(Little Endian)：高位字节放到高位地址

  代表CPU数据保存方式的主机字节序(Host Byte Order)在不同CPU中各不相同，目前主流的Intel系列CPU以小端序保存数据。因此在网络传输数据时约定统一方式，这种约定称为网络字节序(Network Byte Order)－统一为大端序

  htons函数中h代表主机(host)字节序，n代表网络(network)字节序，s指的是short.即可以解释为"将short型数据从主机字节序转化为网络字节序"

  通常以s作为后缀的函数中，s代表２个字节short，因此常用于端口号转换；以l结尾的函数中，l代表4个字节long，因此用于IP地址转换

  　　

- 